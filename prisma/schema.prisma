
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}
datasource db {
  provider = "postgresql"
  url      = env("SUPABASE_CONNECTION_STRING")
  directUrl = env("DIRECT_URL")
}

// Enums
enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum SubscriptionTier {
  BASIC
  PREMIUM
  ELITE
}

enum MatchStatus {
  PENDING
  ACCEPTED
  REJECTED
  BLOCKED
}

enum MessageType {
  TEXT
  FILE
  VOICE
  VIDEO
}

enum RoomType {
  STUDY_GROUP
  DISCUSSION
  HELP_SESSION
  CASUAL
}

enum BadgeType {
  NETWORK_PRO
  CHAT_MASTER
  STUDY_INFLUENCER
  MENTOR
  EARLY_ADOPTER
}

enum AchievementCategory {
  SOCIAL
  ACADEMIC
  ENGAGEMENT
  LEADERSHIP
}

// Core User Model
model User {
  id                String       @id @default(cuid())
  email             String       @unique
  emailVerified     DateTime?
  username          String?      @unique
  firstName         String
  lastName          String
  avatar            String?
  bio               String?
  university        String
  major             String
  year              Int
  gpa               Float?
  status            UserStatus   @default(ACTIVE)
  subscriptionTier  SubscriptionTier @default(BASIC)
  subscriptionExpiry DateTime?

  // Academic Profile
  interests         String[]     // Array of academic interests
  skills            String[]     // Array of skills
  studyGoals        String[]     // Array of study goals
  preferredStudyTime String[]    // Array like ["morning", "evening"]
  languages         String[]     // Array of languages spoken

  // Settings
  isProfilePublic   Boolean      @default(true)
  allowMessages     Boolean      @default(true)
  allowCalls        Boolean      @default(true)
  profileCompleted  Boolean      @default(false)

  // Metrics for AI matching
  responseRate      Float        @default(0.0)
  averageRating     Float        @default(0.0)
  totalMatches      Int          @default(0)
  successfulMatches Int          @default(0)

  // Timestamps
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  lastActive        DateTime     @default(now())

  // Relations
  sentMatches       Match[]      @relation("MatchSender")
  receivedMatches   Match[]      @relation("MatchReceiver")
  sentMessages      Message[]    @relation("MessageSender")
  receivedMessages  Message[]    @relation("MessageReceiver")
  roomMessages      RoomMessage[] @relation("RoomMessageSender")
  ownedRooms        Room[]       @relation("RoomOwner")
  roomMemberships   RoomMember[]
  userBadges        UserBadge[]
  achievements      UserAchievement[]
  ratings           Rating[]     @relation("RatingGiver")
  receivedRatings   Rating[]     @relation("RatingReceiver")
  notifications     Notification[]
  messageReactions  MessageReaction[] @relation("MessageReactions")
  roomMessageReactions RoomMessageReaction[] @relation("RoomMessageReactions")

  @@index([lastActive])
  @@index([university, major])
  @@index([status, subscriptionTier])
  @@map("users")
}

// Matching System
model Match {
  id          String      @id @default(cuid())
  senderId    String
  receiverId  String
  status      MatchStatus @default(PENDING)
  message     String?     // Optional message when sending match request

  // Timestamps
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  respondedAt DateTime?

  // Relations
  sender      User        @relation("MatchSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver    User        @relation("MatchReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@unique([senderId, receiverId])
  @@index([senderId, status])
  @@index([receiverId, status])
  @@index([status, createdAt])
  @@map("matches")
}

// Messaging System
model Message {
  id          String      @id @default(cuid())
  senderId    String
  receiverId  String
  type        MessageType @default(TEXT)
  content     String
  fileUrl     String?     // For file attachments
  fileName    String?     // Original file name
  fileSize    Int?        // File size in bytes
  replyToId   String?     // For message replies
  isEdited    Boolean     @default(false)
  editedAt    DateTime?
  isRead      Boolean     @default(false)

  // Timestamps
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  readAt      DateTime?

  // Relations
  sender      User        @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver    User        @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  replyTo     Message?    @relation("MessageReply", fields: [replyToId], references: [id], onDelete: SetNull)
  replies     Message[]   @relation("MessageReply")
  reactions   MessageReaction[]

  @@map("messages")
}

// Message Reactions
model MessageReaction {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  emoji     String

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation("MessageReactions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
  @@map("message_reactions")
}

// Voice/Video Chat Rooms
model Room {
  id              String       @id @default(cuid())
  name            String
  description     String?
  type            RoomType     @default(STUDY_GROUP)
  topic           String?      // Academic topic/subject
  maxMembers      Int          @default(10)
  isPrivate       Boolean      @default(false)
  password        String?      // For private rooms
  ownerId         String

  // Room settings
  allowVideo      Boolean      @default(true)
  allowVoice      Boolean      @default(true)
  allowText       Boolean      @default(true)
  allowScreenShare Boolean     @default(false) // Premium feature

  // Timestamps
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  lastActivity    DateTime     @default(now())

  // Relations
  owner           User         @relation("RoomOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members         RoomMember[]
  messages        RoomMessage[]

  @@map("rooms")
}

model RoomMember {
  id        String    @id @default(cuid())
  roomId    String
  userId    String
  joinedAt  DateTime  @default(now())
  leftAt    DateTime?
  isMuted   Boolean   @default(false)
  isBanned  Boolean   @default(false)

  // Relations
  room      Room      @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([roomId, userId])
  @@index([userId, leftAt])
  @@index([roomId, leftAt, isBanned])
  @@map("room_members")
}

// Room Messages for Group Chat
model RoomMessage {
  id          String      @id @default(cuid())
  roomId      String
  senderId    String
  type        MessageType @default(TEXT)
  content     String
  fileUrl     String?     // For file attachments
  fileName    String?     // Original file name
  fileSize    Int?        // File size in bytes
  replyToId   String?     // For message replies
  isEdited    Boolean     @default(false)
  editedAt    DateTime?

  // Timestamps
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  room        Room        @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sender      User        @relation("RoomMessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  replyTo     RoomMessage? @relation("MessageReply", fields: [replyToId], references: [id])
  replies     RoomMessage[] @relation("MessageReply")
  reactions   RoomMessageReaction[]

  @@map("room_messages")
}

// Room Message Reactions
model RoomMessageReaction {
  id        String      @id @default(cuid())
  messageId String
  userId    String
  emoji     String

  // Timestamps
  createdAt DateTime    @default(now())

  // Relations
  message   RoomMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User        @relation("RoomMessageReactions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
  @@map("room_message_reactions")
}

// Achievement System
model Badge {
  id            String      @id @default(cuid())
  name          String      @unique
  description   String
  type          BadgeType
  icon          String      // URL to badge icon
  requirement   String      // Description of how to earn this badge
  isActive      Boolean     @default(true)

  // Timestamps
  createdAt     DateTime    @default(now())

  // Relations
  userBadges    UserBadge[]

  @@map("badges")
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String
  earnedAt  DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@map("user_badges")
}

model Achievement {
  id          String                @id @default(cuid())
  name        String                @unique
  description String
  category    AchievementCategory
  points      Int                   @default(0)
  requirement String                // JSON string describing requirements
  isActive    Boolean               @default(true)

  // Timestamps
  createdAt   DateTime              @default(now())

  // Relations
  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  achievementId String
  progress      Float       @default(0.0) // Progress towards achievement (0.0 - 1.0)
  completedAt   DateTime?

  // Relations
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

// Rating System
model Rating {
  id         String   @id @default(cuid())
  giverId    String
  receiverId String
  rating     Int      // 1-5 stars
  comment    String?
  context    String?  // "study_session", "room_interaction", etc.

  // Timestamps
  createdAt  DateTime @default(now())

  // Relations
  giver      User     @relation("RatingGiver", fields: [giverId], references: [id], onDelete: Cascade)
  receiver   User     @relation("RatingReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@unique([giverId, receiverId, context])
  @@map("ratings")
}

// Notifications System
enum NotificationType {
  MATCH_REQUEST      // Someone sent you a match request
  MATCH_ACCEPTED     // Your match request was accepted
  NEW_MESSAGE        // New message from connection
  ROOM_INVITE        // Invited to a study room
  BADGE_EARNED       // Earned a new badge
  ACHIEVEMENT_UNLOCKED // Unlocked an achievement
}

model Notification {
  id          String           @id @default(cuid())
  userId      String           // Recipient of notification
  type        NotificationType
  title       String
  message     String
  isRead      Boolean          @default(false)

  // Related entities
  relatedUserId String?        // e.g., user who sent match request
  relatedMatchId String?        // e.g., match request ID
  relatedMessageId String?      // e.g., message ID
  relatedRoomId String?         // e.g., room ID

  metadata    Json?            // Additional data

  // Timestamps
  createdAt   DateTime         @default(now())
  readAt      DateTime?

  // Relations
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([userId, isRead, createdAt])
  @@map("notifications")
}

// Analytics and Metrics
model UserActivity {
  id            String   @id @default(cuid())
  userId        String
  activityType  String   // "login", "match_sent", "message_sent", "room_joined", etc.
  metadata      Json?    // Additional data about the activity

  // Timestamps
  createdAt     DateTime @default(now())

  @@map("user_activities")
}

model DailyMetrics {
  id              String   @id @default(cuid())
  date            DateTime @unique @db.Date
  totalUsers      Int      @default(0)
  activeUsers     Int      @default(0)
  newUsers        Int      @default(0)
  totalMatches    Int      @default(0)
  successfulMatches Int    @default(0)
  totalMessages   Int      @default(0)
  totalRooms      Int      @default(0)
  activeRooms     Int      @default(0)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("daily_metrics")
}